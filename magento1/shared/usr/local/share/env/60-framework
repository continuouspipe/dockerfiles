#!/bin/bash

# Relative MAGE_ROOT converted to absolute path
if ! [[ "$MAGE_ROOT" =~ ^/ ]]; then
  export MAGE_ROOT=${WORK_DIRECTORY}/${MAGE_ROOT}
fi

if [ "$WEB_HTTPS_ONLY" == "true" ]; then
  PUBLIC_ADDRESS_UNSECURE_SCHEME=https
else
  PUBLIC_ADDRESS_UNSECURE_SCHEME=http
fi

if [ "$WEB_HTTPS" == "true" ] || [ "$WEB_HTTPS_OFFLOADED" == "true" ] || [ "$WEB_REVERSE_PROXIED" == "true" ]; then
  PUBLIC_ADDRESS_SECURE_SCHEME=https
else
  PUBLIC_ADDRESS_SECURE_SCHEME=http
fi

if [ -n "${PUBLIC_ADDRESS:-}" ]; then
  echo 'deprecated: PUBLIC_ADDRESS is deprecated, please set WEB_HOST or PUBLIC_ADDRESS_UNSECURE/PUBLIC_ADDRESS_SECURE instead' >&2

  export PUBLIC_ADDRESS_UNSECURE=${PUBLIC_ADDRESS_UNSECURE:-$PUBLIC_ADDRESS}
  export PUBLIC_ADDRESS_SECURE=${PUBLIC_ADDRESS_SECURE:-$PUBLIC_ADDRESS}
else
  export PUBLIC_ADDRESS_UNSECURE=${PUBLIC_ADDRESS_UNSECURE:-$PUBLIC_ADDRESS_UNSECURE_SCHEME://$WEB_HOST/}
  export PUBLIC_ADDRESS_SECURE=${PUBLIC_ADDRESS_SECURE:-$PUBLIC_ADDRESS_SECURE_SCHEME://$WEB_HOST/}

  # for deprecated BC
  export PUBLIC_ADDRESS=${PUBLIC_ADDRESS_SECURE}
fi
