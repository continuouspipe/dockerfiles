#!/bin/bash

export PHP_TIMEZONE=${PHP_TIMEZONE:-UTC}
export PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT:-256M}
export PHP_MEMORY_LIMIT_CLI=${PHP_MEMORY_LIMIT_CLI:--1}
export PHP_OPCACHE_MAX_ACCELERATED_FILES=${PHP_OPCACHE_MAX_ACCELERATED_FILES:-2000}
export PHP_REALPATH_CACHE_SIZE=${PHP_REALPATH_CACHE_SIZE:-16K}
export PHP_REALPATH_CACHE_TTL=${PHP_REALPATH_CACHE_TTL:-120}
export APP_USER=${APP_USER:-www-data}
export APP_GROUP=${APP_GROUP:-www-data}

export START_MODE=${START_MODE:-web}
declare "START_MODE_${START_MODE^^}=true"

START_NGINX=${START_NGINX:-${START_MODE_WEB:-false}}
START_NGINX="$(convert_to_boolean_string "$START_NGINX")"
export START_NGINX
START_PHP_FPM=${START_PHP_FPM:-${START_MODE_WEB:-false}}
START_PHP_FPM="$(convert_to_boolean_string "$START_PHP_FPM")"
export START_PHP_FPM
START_CRON=${START_CRON:-${START_MODE_CRON:-false}}
START_CRON="$(convert_to_boolean_string "$START_CRON")"
export START_CRON

export WORK_DIRECTORY=${WORK_DIRECTORY:-/app}
export WEB_DIRECTORY=${WEB_DIRECTORY:-web}

COMPOSER_CLEAR_CACHE=${COMPOSER_CLEAR_CACHE:-true}
COMPOSER_CLEAR_CACHE="$(convert_to_boolean_string "$COMPOSER_CLEAR_CACHE")"
export COMPOSER_CLEAR_CACHE

export WEB_HOST=${WEB_HOST:-localhost}
export WEB_HTTP_PORT=${WEB_HTTP_PORT:-80}
WEB_HTTPS=${WEB_HTTPS:-true}
WEB_HTTPS="$(convert_to_boolean_string "$WEB_HTTPS")"
export WEB_HTTPS
export WEB_HTTP=${WEB_HTTP:-auto}
export WEB_HTTPS_PORT=${WEB_HTTPS_PORT:-443}
WEB_HTTPS_OFFLOADED=${WEB_HTTPS_OFFLOADED:-false}
WEB_HTTPS_OFFLOADED="$(convert_to_boolean_string "$WEB_HTTPS_OFFLOADED")"
export WEB_HTTPS_OFFLOADED
WEB_REVERSE_PROXIED=${WEB_REVERSE_PROXIED:-true}
WEB_REVERSE_PROXIED="$(convert_to_boolean_string "$WEB_REVERSE_PROXIED")"
export WEB_REVERSE_PROXIED
export WEB_SSL_FULLCHAIN=${WEB_SSL_FULLCHAIN:-/etc/ssl/certs/fullchain.pem}
export WEB_SSL_PRIVKEY=${WEB_SSL_PRIVKEY:-/etc/ssl/certs/privkey.pem}

AUTH_HTTP_ENABLED=${AUTH_HTTP_ENABLED:-}
AUTH_HTTP_ENABLED="$(convert_to_boolean_string "$AUTH_HTTP_ENABLED")"
export AUTH_HTTP_ENABLED
export AUTH_HTTP_REALM=${AUTH_HTTP_REALM:-Protected System}
export AUTH_HTTP_FILE=${AUTH_HTTP_FILE:-/etc/nginx/htpasswd}
export AUTH_HTTP_REMOTE_URL=${AUTH_HTTP_REMOTE_URL:-}
export AUTH_HTTP_HTPASSWD=${AUTH_HTTP_HTPASSWD:-}
export AUTH_HTTP_HEALTHCHECK_USER_AGENT=${AUTH_HTTP_HEALTHCHECK_USER_AGENT:-}
export AUTH_HTTP_HEALTHCHECK_LOCATION=${AUTH_HTTP_HEALTHCHECK_LOCATION:-}
AUTH_IP_WHITELIST_ENABLED=${AUTH_IP_WHITELIST_ENABLED:-}
AUTH_IP_WHITELIST_ENABLED="$(convert_to_boolean_string "$AUTH_IP_WHITELIST_ENABLED")"
export AUTH_IP_WHITELIST_ENABLED
export AUTH_IP_WHITELIST=${AUTH_IP_WHITELIST:-
  127.0.0.0/8,
  ::1
}

export EXTERNAL_LOAD_BALANCER_IP=${EXTERNAL_LOAD_BALANCER_IP:-}
export EXTERNAL_LOAD_BALANCER_HOST=${EXTERNAL_LOAD_BALANCER_HOST:-${EXTERNAL_LOAD_BALANCER_IP}}
if [ -n "${EXTERNAL_LOAD_BALANCER_HOST}" ]; then
  EXTERNAL_LOAD_BALANCER_HOST_IPS=$(getent hosts "$EXTERNAL_LOAD_BALANCER_HOST" | awk '{ print $1 }')
  export EXTERNAL_LOAD_BALANCER_HOST_IPS
fi
export TRUSTED_REVERSE_PROXIES=${TRUSTED_REVERSE_PROXIES:-}
