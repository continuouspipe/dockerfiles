#!/bin/bash

export IMAGE_VERSION=${IMAGE_VERSION:-1}

export PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT:-768M}
export PHP_MAX_EXECUTION_TIME=${PHP_MAX_EXECUTION_TIME:-600}

export PHP_OPCACHE_MAX_ACCELERATED_FILES=${PHP_OPCACHE_MAX_ACCELERATED_FILES:-16384}
export PHP_REALPATH_CACHE_SIZE=${PHP_REALPATH_CACHE_SIZE:-4096K}
export PHP_REALPATH_CACHE_TTL=${PHP_REALPATH_CACHE_TTL:-600}
export PHP_OPCACHE_MEMORY_CONSUMPTION=${PHP_OPCACHE_MEMORY_CONSUMPTION:-256}

PRODUCTION_ENVIRONMENT=${PRODUCTION_ENVIRONMENT:-false}
PRODUCTION_ENVIRONMENT="$(convert_to_boolean_string "$PRODUCTION_ENVIRONMENT")"
export PRODUCTION_ENVIRONMENT

export APP_HOSTNAME=${APP_HOSTNAME:-magento.docker}
export PUBLIC_ADDRESS=${PUBLIC_ADDRESS:-https://magento.docker/}

FORCE_DATABASE_DROP=${FORCE_DATABASE_DROP:-false}
FORCE_DATABASE_DROP="$(convert_to_boolean_string "$FORCE_DATABASE_DROP")"
export FORCE_DATABASE_DROP
export DATABASE_ARCHIVE_PATH=${DATABASE_ARCHIVE_PATH:-tools/assets/development/magentodb.sql.gz}

export DATABASE_NAME=${DATABASE_NAME:-magentodb}
export DATABASE_USER=${DATABASE_USER:-magento}
export DATABASE_USER_HOST=${DATABASE_USER_HOST:-%}
export DATABASE_PASSWORD=${DATABASE_PASSWORD:-magento}
export DATABASE_HOST=${DATABASE_HOST:-database}
export ADDITIONAL_SETUP_SQL=${ADDITIONAL_SETUP_SQL:-}

# deprecated
export DATABASE_ROOT_PASSWORD=${DATABASE_ROOT_PASSWORD:-}

if [ -n "$DATABASE_ROOT_PASSWORD" ]; then
  export DATABASE_ADMIN_USER=${DATABASE_ADMIN_USER:-root}
  export DATABASE_ADMIN_PASSWORD=${DATABASE_ADMIN_PASSWORD:-$DATABASE_ROOT_PASSWORD}
else
  export DATABASE_ADMIN_USER=${DATABASE_ADMIN_USER:-}
  export DATABASE_ADMIN_PASSWORD=${DATABASE_ADMIN_PASSWORD:-}
fi

export AWS_S3_BUCKET=${AWS_S3_BUCKET:-}
export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
export ASSET_DOWNLOAD_EXCLUDE_PATTERN=${ASSET_DOWNLOAD_EXCLUDE_PATTERN:-}
export ASSET_ARCHIVE_PATH=${ASSET_ARCHIVE_PATH:-tools/assets/development/media.files.tgz}
export ASSET_DOWNLOAD_ENVIRONMENTS=${ASSET_DOWNLOAD_ENVIRONMENTS:-development}

export FRONTEND_INSTALL_DIRECTORY=${FRONTEND_INSTALL_DIRECTORY:-/app/tools/inviqa}
export FRONTEND_BUILD_DIRECTORY=${FRONTEND_BUILD_DIRECTORY:-/app/tools/inviqa}
export FRONTEND_BUILD_ACTION=${FRONTEND_BUILD_ACTION:-build}
export GULP_BUILD_THEME_NAME=${GULP_BUILD_THEME_NAME:-}

export MAGENTO_MODE=${MAGENTO_MODE:-production}
export MAGE_MODE=${MAGE_MODE:-${MAGENTO_MODE}}
DEFAULT_MAGENTO_RUN_CODE_MAPPING="$APP_HOSTNAME default;"
export MAGENTO_RUN_CODE_MAPPING=${MAGENTO_RUN_CODE_MAPPING:-$DEFAULT_MAGENTO_RUN_CODE_MAPPING}
export MAGENTO_RUN_TYPE=${MAGENTO_RUN_TYPE:-store}

export FRONTEND_COMPILE_LANGUAGES=${FRONTEND_COMPILE_LANGUAGES:-en_GB}
export MAGENTO_DEPENDENCY_INJECTION_COMPILE_COMMAND=${MAGENTO_DEPENDENCY_INJECTION_COMPILE_COMMAND:-bin/magento setup:di:compile}

export MAGENTO_CRYPT_KEY=${MAGENTO_CRYPT_KEY:-}

export COMPOSER_CUSTOM_CONFIG_COMMAND=${COMPOSER_CUSTOM_CONFIG_COMMAND:-}


DEFAULT_COMPOSER_FLAGS="--no-interaction"
if [ -z "$DEVELOPMENT_MODE" ] || [ "$DEVELOPMENT_MODE" != "true" ]; then
  DEFAULT_COMPOSER_FLAGS="${DEFAULT_COMPOSER_FLAGS} --no-dev"
fi
export COMPOSER_INSTALL_FLAGS=${COMPOSER_INSTALL_FLAGS:-$DEFAULT_COMPOSER_FLAGS}

MAGENTO_ENABLE_CACHE=${MAGENTO_ENABLE_CACHE:-true}
MAGENTO_ENABLE_CACHE="$(convert_to_boolean_string "$MAGENTO_ENABLE_CACHE")"
export MAGENTO_ENABLE_CACHE

MAGENTO_USE_REDIS=${MAGENTO_USE_REDIS:-true}
MAGENTO_USE_REDIS="$(convert_to_boolean_string "$MAGENTO_USE_REDIS")"
export MAGENTO_USE_REDIS

deprecate_env_var REDIS_HOST_PORT REDIS_PORT

export REDIS_HOST=${REDIS_HOST:-redis}
REDIS_PORT="$(canonical_port "${REDIS_PORT:-6379}")"
export REDIS_PORT
export MAGENTO_REDIS_CACHE_DATABASE=${MAGENTO_REDIS_CACHE_DATABASE:-0}
export MAGENTO_REDIS_FULL_PAGE_CACHE_DATABASE=${MAGENTO_REDIS_FULL_PAGE_CACHE_DATABASE:-1}
export MAGENTO_REDIS_SESSION_DATABASE=${MAGENTO_REDIS_SESSION_DATABASE:-2}
MAGENTO_REDIS_FORCE_STANDALONE=${MAGENTO_REDIS_FORCE_STANDALONE:-true}
MAGENTO_REDIS_FORCE_STANDALONE="$(convert_to_boolean_string "$MAGENTO_REDIS_FORCE_STANDALONE")"
export MAGENTO_REDIS_FORCE_STANDALONE


REDIS_USE_SENTINEL=${REDIS_USE_SENTINEL:-false}
REDIS_USE_SENTINEL="$(convert_to_boolean_string "$REDIS_USE_SENTINEL")"
export REDIS_USE_SENTINEL
export REDIS_SENTINEL_HOSTS=${REDIS_SENTINEL_HOSTS:-tcp://redis-sentinel-0.redis-sentinel-headless:26379,tcp://redis-sentinel-1.redis-sentinel-headless:26379,tcp://redis-sentinel-2.redis-sentinel-headless:26379}
export REDIS_SENTINEL_MASTER=${REDIS_SENTINEL_MASTER:-mymaster}
export REDIS_SENTINEL_SERVICE_HOST=${REDIS_SENTINEL_SERVICE_HOST:-redis-sentinel-headless}
export REDIS_SENTINEL_SERVICE_PORT=${REDIS_SENTINEL_SERVICE_PORT:-26379}

export MAGENTO_ADMIN_FRONTNAME=${MAGENTO_ADMIN_FRONTNAME:-admin}
export MAGENTO_ADMIN_FRONTNAME_REGEX_ESCAPED=${MAGENTO_ADMIN_FRONTNAME_REGEX_ESCAPED:-$MAGENTO_ADMIN_FRONTNAME}
MAGENTO_PROTECT_ADMIN=${MAGENTO_PROTECT_ADMIN:-false}
MAGENTO_PROTECT_ADMIN="$(convert_to_boolean_string "$MAGENTO_PROTECT_ADMIN")"
export MAGENTO_PROTECT_ADMIN
export MAGENTO_ADMIN_HTPASSWD=${MAGENTO_ADMIN_HTPASSWD:-}

export MAGENTO_HTTP_CACHE_HOSTS=${MAGENTO_HTTP_CACHE_HOSTS:-}
export MAGENTO_HTTP_CACHE_PORT=${MAGENTO_HTTP_CACHE_PORT:-80}

export TIDEWAYS_FRAMEWORK=${TIDEWAYS_FRAMEWORK:-magento2}

RUN_MAGENTO_CRON=${RUN_MAGENTO_CRON:-true}
RUN_MAGENTO_CRON="$(convert_to_boolean_string "$RUN_MAGENTO_CRON")"
export RUN_MAGENTO_CRON

RUN_REPORTS_CRON=${RUN_REPORTS_CRON:-true}
RUN_REPORTS_CRON="$(convert_to_boolean_string "$RUN_REPORTS_CRON")"
export RUN_REPORTS_CRON

MAGENTO_ALLOW_ACCESS_TO_SETUP=${MAGENTO_ALLOW_ACCESS_TO_SETUP:-true}
MAGENTO_ALLOW_ACCESS_TO_SETUP="$(convert_to_boolean_string "$MAGENTO_ALLOW_ACCESS_TO_SETUP")"
export MAGENTO_ALLOW_ACCESS_TO_SETUP
MAGENTO_ALLOW_ACCESS_TO_UPDATE=${MAGENTO_ALLOW_ACCESS_TO_UPDATE:-true}
MAGENTO_ALLOW_ACCESS_TO_UPDATE="$(convert_to_boolean_string "$MAGENTO_ALLOW_ACCESS_TO_UPDATE")"
export MAGENTO_ALLOW_ACCESS_TO_UPDATE

MAGENTO_RUN_BUILD=${MAGENTO_RUN_BUILD:-true}
MAGENTO_RUN_BUILD="$(convert_to_boolean_string "$MAGENTO_RUN_BUILD")"
export MAGENTO_RUN_BUILD

export MAGENTO_ADMIN_USERNAME=${MAGENTO_ADMIN_USERNAME:-}
export MAGENTO_ADMIN_PASSWORD=${MAGENTO_ADMIN_PASSWORD:-}
export MAGENTO_ADMIN_EMAIL=${MAGENTO_ADMIN_EMAIL:-admin@example.com}

MAGENTO_CACHE_STATIC_ASSETS=${MAGENTO_CACHE_STATIC_ASSETS:-false}
MAGENTO_CACHE_STATIC_ASSETS="$(convert_to_boolean_string "$MAGENTO_CACHE_STATIC_ASSETS")"
export MAGENTO_CACHE_STATIC_ASSETS

MAGENTO_ENABLE_CONFIG_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_CONFIG_CACHE:-true}")
export MAGENTO_ENABLE_CONFIG_CACHE
MAGENTO_ENABLE_LAYOUT_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_LAYOUT_CACHE:-true}")
export MAGENTO_ENABLE_LAYOUT_CACHE
MAGENTO_ENABLE_BLOCK_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_BLOCK_CACHE:-true}")
export MAGENTO_ENABLE_BLOCK_CACHE
MAGENTO_ENABLE_COLLECTION_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_COLLECTION_CACHE:-true}")
export MAGENTO_ENABLE_COLLECTION_CACHE
MAGENTO_ENABLE_REFLECTION_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_REFLECTION_CACHE:-true}")
export MAGENTO_ENABLE_REFLECTION_CACHE
MAGENTO_ENABLE_DDL_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_DDL_CACHE:-true}")
export MAGENTO_ENABLE_DDL_CACHE
MAGENTO_ENABLE_EAV_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_EAV_CACHE:-true}")
export MAGENTO_ENABLE_EAV_CACHE
MAGENTO_ENABLE_NOTIFICATION_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_NOTIFICATION_CACHE:-true}")
export MAGENTO_ENABLE_NOTIFICATION_CACHE
MAGENTO_ENABLE_FULLPAGE_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_FULLPAGE_CACHE:-true}")
export MAGENTO_ENABLE_FULLPAGE_CACHE
MAGENTO_ENABLE_CONFIG_INTEGRATION_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_CONFIG_INTEGRATION_CACHE:-true}")
export MAGENTO_ENABLE_CONFIG_INTEGRATION_CACHE
MAGENTO_ENABLE_CONFIG_INTEGRATION_API_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_CONFIG_INTEGRATION_API_CACHE:-true}")
export MAGENTO_ENABLE_CONFIG_INTEGRATION_API_CACHE
MAGENTO_ENABLE_TRANSLATE_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_TRANSLATE_CACHE:-true}")
export MAGENTO_ENABLE_TRANSLATE_CACHE
MAGENTO_ENABLE_CONFIG_WEBSERVICE_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_CONFIG_WEBSERVICE_CACHE:-true}")
export MAGENTO_ENABLE_CONFIG_WEBSERVICE_CACHE
MAGENTO_ENABLE_TARGET_RULE_CACHE=$(convert_to_boolean_string "${MAGENTO_ENABLE_TARGET_RULE_CACHE:-true}")
export MAGENTO_ENABLE_TARGET_RULE_CACHE

MAGENTO_ENTERPRISE_EDITION=$(convert_to_boolean_string "${MAGENTO_ENTERPRISE_EDITION:-$(run_return_boolean has_composer_package "magento/product-enterprise-edition")}")
export MAGENTO_ENTERPRISE_EDITION

export MAGENTO_VERSION="${MAGENTO_VERSION:-$(composer_package_version magento/product-community-edition | cut -d. -f1,2)}"
