#!/bin/bash

if [ -n "${PHP_FULL_VERSION:-}" ]; then
  export PHP_VERSION=${PHP_FULL_VERSION%.[0-9]*}
fi

export PHP_TIMEZONE=${PHP_TIMEZONE:-UTC}
export PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT:-256M}
export PHP_OPCACHE_INTERNED_STRINGS_BUFFER=${PHP_OPCACHE_INTERNED_STRINGS_BUFFER:-8}
export PHP_OPCACHE_MAX_ACCELERATED_FILES=${PHP_OPCACHE_MAX_ACCELERATED_FILES:-2000}
export PHP_OPCACHE_MEMORY_CONSUMPTION=${PHP_OPCACHE_MEMORY_CONSUMPTION:-64}
if [ -z "$PHP_OPCACHE_VALIDATE_TIMESTAMPS" ]; then
  export PHP_OPCACHE_VALIDATE_TIMESTAMPS=1
  export PHP_OPCACHE_VALIDATE_TIMESTAMPS_IS_DEFAULT="true"
fi
export PHP_OPCACHE_ENABLE_CLI=${PHP_OPCACHE_ENABLE_CLI:-0}
export PHP_REALPATH_CACHE_SIZE=${PHP_REALPATH_CACHE_SIZE:-16K}
export PHP_REALPATH_CACHE_TTL=${PHP_REALPATH_CACHE_TTL:-120}

export APP_USER=${APP_USER:-www-data}
export APP_GROUP=${APP_GROUP:-www-data}

export START_MODE=${START_MODE:-web}
declare "START_MODE_${START_MODE^^}=true"

START_WEB="$(convert_to_boolean_string "${START_WEB:-${START_MODE_WEB:-false}}")"
export START_WEB

START_CRON="$(convert_to_boolean_string "${START_CRON:-${START_MODE_CRON:-false}}")"
export START_CRON

APP_ENDPOINT_REWRITE="$(convert_to_boolean_string "${APP_ENDPOINT_REWRITE-true}")"
export APP_ENDPOINT_REWRITE
APP_ENDPOINT_STRICT="$(convert_to_boolean_string "${APP_ENDPOINT_STRICT:-false}")"
export APP_ENDPOINT_STRICT
export APP_ENDPOINT=${APP_ENDPOINT:-/index.php}

TIDEWAYS_ENABLED="$(convert_to_boolean_string "${TIDEWAYS_ENABLED:-false}")"
export TIDEWAYS_ENABLED
export TIDEWAYS_FRAMEWORK=${TIDEWAYS_FRAMEWORK:-}
export TIDEWAYS_API_KEY=${TIDEWAYS_API_KEY:-}
export TIDEWAYS_CONNECTION=${TIDEWAYS_CONNECTION:-tcp://tideways:9135}
export TIDEWAYS_SERVICE=${TIDEWAYS_SERVICE:-}
export TIDEWAYS_SAMPLE_RATE=${TIDEWAYS_SAMPLE_RATE:-25}
export TIDEWAYS_COLLECT=${TIDEWAYS_COLLECT:-TRACING}

XDEBUG_REMOTE_ENABLED="$(convert_to_boolean_string "${XDEBUG_REMOTE_ENABLED:-false}")"
export XDEBUG_REMOTE_ENABLED
export XDEBUG_REMOTE_HOST=${XDEBUG_REMOTE_HOST:-sshforward}
export XDEBUG_REMOTE_PORT=${XDEBUG_REMOTE_PORT:-9000}
XDEBUG_REMOTE_AUTOSTART="$(convert_to_boolean_string "${XDEBUG_REMOTE_AUTOSTART:-false}")"
export XDEBUG_REMOTE_AUTOSTART

export WEB_DIRECTORY=${WEB_DIRECTORY:-web}
export WEB_HOST=${WEB_HOST:-localhost}
export WEB_HTTP_PORT=${WEB_HTTP_PORT:-80}
WEB_HTTPS="$(convert_to_boolean_string "${WEB_HTTPS:-true}")"
export WEB_HTTPS
export WEB_HTTP=${WEB_HTTP:-auto}
export WEB_HTTPS_PORT=${WEB_HTTPS_PORT:-443}
WEB_HTTPS_OFFLOADED="$(convert_to_boolean_string "${WEB_HTTPS_OFFLOADED:-false}")"
export WEB_HTTPS_OFFLOADED
WEB_REVERSE_PROXIED="$(convert_to_boolean_string "${WEB_REVERSE_PROXIED:-true}")"
export WEB_REVERSE_PROXIED

if is_true "${WEB_SSL_CIPHERS_SWEET32_FIX:-}"; then
  SSL_CIPHERS_SWEET32_DH=""
  SSL_CIPHERS_SWEET32_RSA=""
else
  SSL_CIPHERS_SWEET32_DH="ECDH+3DES:DH+3DES"
  SSL_CIPHERS_SWEET32_RSA="RSA+3DES"
fi

if is_true "${WEB_SSL_CIPHERS_RSA_FIX:-}"; then
  SSL_CIPHERS_RSA=""
else
  SSL_CIPHERS_RSA="RSA+AESGCM:RSA+AES:${SSL_CIPHERS_SWEET32_RSA}"
fi

DEFAULT_SSL_CIPHERS="ECDH+ECDSA+AESGCM:ECDH+aRSA+AESGCM:DH+AESGCM:ECDH+ECDSA+AES256:ECDH+aRSA+AES256:DH+AES256:ECDH+ECDSA+AES128:ECDH+aRSA+AES128:DH+AES:${SSL_CIPHERS_SWEET32_DH}:${SSL_CIPHERS_RSA}:!aNULL:!MD5:!DSS"

export WEB_SSL_CIPHERS=${WEB_SSL_CIPHERS:-$DEFAULT_SSL_CIPHERS}
export WEB_SSL_DHPARAM_FILE=${WEB_SSL_DHPARAM_FILE:-/etc/ssl/private/dhparam}
WEB_SSL_DHPARAM_ENABLE="$(convert_to_boolean_string "${WEB_SSL_DHPARAM_ENABLE:-false}")"
export WEB_SSL_DHPARAM_ENABLE
export WEB_SSL_DHPARAM_CRON="${WEB_SSL_DHPARAM_CRON:-@daily}"
export WEB_SSL_DHPARAM_TYPE="${WEB_SSL_DHPARAM_TYPE:-dh}"
export WEB_SSL_DHPARAM_SIZE=${WEB_SSL_DHPARAM_SIZE:-2048}
export WEB_SSL_FULLCHAIN=${WEB_SSL_FULLCHAIN:-/etc/ssl/certs/fullchain.pem}
export WEB_SSL_PRIVKEY=${WEB_SSL_PRIVKEY:-/etc/ssl/certs/privkey.pem}
export WEB_SSL_SESSION_CACHE=${WEB_SSL_SESSION_CACHE:-none}
export WEB_SSL_SESSION_TIMEOUT=${WEB_SSL_SESSION_TIMEOUT:-5m}
WEB_SSL_OCSP_STAPLING="$(convert_to_boolean_string "${WEB_SSL_OCSP_STAPLING:-false}")"
export WEB_SSL_OCSP_STAPLING

AUTH_HTTP_ENABLED="$(convert_to_boolean_string "${AUTH_HTTP_ENABLED:-}")"
export AUTH_HTTP_ENABLED
export AUTH_HTTP_REALM=${AUTH_HTTP_REALM:-Protected System}
export AUTH_HTTP_REMOTE_URL=${AUTH_HTTP_REMOTE_URL:-}
export AUTH_HTTP_HTPASSWD=${AUTH_HTTP_HTPASSWD:-}
export AUTH_HTTP_HEALTHCHECK_USER_AGENT=${AUTH_HTTP_HEALTHCHECK_USER_AGENT:-}
export AUTH_HTTP_HEALTHCHECK_LOCATION=${AUTH_HTTP_HEALTHCHECK_LOCATION:-}
AUTH_IP_WHITELIST_ENABLED="$(convert_to_boolean_string "${AUTH_IP_WHITELIST_ENABLED:-}")"
export AUTH_IP_WHITELIST_ENABLED
export AUTH_IP_WHITELIST=${AUTH_IP_WHITELIST:-
  127.0.0.0/8,
  ::1
}

export EXTERNAL_LOAD_BALANCER_IP=${EXTERNAL_LOAD_BALANCER_IP:-}
export EXTERNAL_LOAD_BALANCER_HOST=${EXTERNAL_LOAD_BALANCER_HOST:-${EXTERNAL_LOAD_BALANCER_IP}}
if [ -n "${EXTERNAL_LOAD_BALANCER_HOST}" ]; then
  EXTERNAL_LOAD_BALANCER_HOST_IPS=$(getent hosts "$EXTERNAL_LOAD_BALANCER_HOST" | awk '{ print $1 }')
  export EXTERNAL_LOAD_BALANCER_HOST_IPS
fi
export TRUSTED_REVERSE_PROXIES=${TRUSTED_REVERSE_PROXIES:-}

export SENDMAIL_RELAY_HOST=${SENDMAIL_RELAY_HOST:-}
export SENDMAIL_RELAY_PORT=${SENDMAIL_RELAY_PORT:-25}
export SENDMAIL_RELAY_USER=${SENDMAIL_RELAY_USER:-}
export SENDMAIL_RELAY_PASSWORD=${SENDMAIL_RELAY_PASSWORD:-}
export SENDMAIL_RELAY_TLS_SECURITY_LEVEL=${SENDMAIL_RELAY_TLS_SECURITY_LEVEL:-may}
